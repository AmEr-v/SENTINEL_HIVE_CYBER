<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sentinel Hive Dashboard</title>
	<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');

:root {
	--bg: #0b1220;
	--panel: #0f172a;
	--card: #0f1b2e;
	--card-2: #0c1526;
	--accent: #22d3ee;
	--accent-2: #f97316;
	--accent-3: #84cc16;
	--text: #e2e8f0;
	--muted: #94a3b8;
	--border: #1f2a44;
	--shadow: 0 20px 50px rgba(2, 6, 23, 0.55);
	--font-body: 'Space Grotesk', sans-serif;
	--font-mono: 'IBM Plex Mono', 'JetBrains Mono', monospace;
}
* { box-sizing: border-box; }
body {
	margin: 0;
	min-height: 100vh;
	color: var(--text);
	font-family: var(--font-body);
	font-size: 15px;
	line-height: 1.6;
	background:
		radial-gradient(1200px circle at 15% -10%, #1b2a49 0%, rgba(27, 42, 73, 0) 60%),
		radial-gradient(900px circle at 90% 0%, #12374d 0%, rgba(18, 55, 77, 0) 65%),
		linear-gradient(180deg, #0b1220 0%, #0b1324 100%);
}
body::before {
	content: "";
	position: fixed;
	inset: 0;
	background:
		repeating-linear-gradient(90deg, rgba(148, 163, 184, 0.04) 0 1px, transparent 1px 140px),
		repeating-linear-gradient(0deg, rgba(148, 163, 184, 0.035) 0 1px, transparent 1px 90px);
	pointer-events: none;
	z-index: 0;
}
body::after {
	content: "";
	position: fixed;
	inset: -10% auto auto -10%;
	width: 480px;
	height: 480px;
	background: radial-gradient(circle, rgba(34, 211, 238, 0.18), transparent 70%);
	pointer-events: none;
	z-index: 0;
}
.app-header {
	padding: 20px 28px;
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 16px;
	border-bottom: 1px solid var(--border);
	background: linear-gradient(110deg, rgba(15, 23, 42, 0.94), rgba(11, 18, 32, 0.92));
	position: sticky;
	top: 0;
	z-index: 20;
	backdrop-filter: blur(14px);
	box-shadow: 0 12px 30px rgba(2, 6, 23, 0.45);
}
.brand { letter-spacing: 4px; text-transform: uppercase; color: var(--accent); font-weight: 700; font-size: 19px; }
.sub { color: var(--muted); font-size: 13px; margin-top: 6px; font-family: var(--font-mono); }
.app-main { padding: 24px 28px 70px; max-width: 1280px; margin: auto; position: relative; z-index: 1; }
.grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
.card {
	background: linear-gradient(160deg, var(--card) 0%, var(--card-2) 100%);
	border: 1px solid var(--border);
	padding: 18px 20px;
	border-radius: 14px;
	box-shadow: var(--shadow);
	position: relative;
	overflow: hidden;
}
.card::before {
	content: "";
	position: absolute;
	inset: 0;
	background:
		radial-gradient(420px circle at 10% -10%, rgba(34, 211, 238, 0.18), transparent 60%),
		radial-gradient(280px circle at 80% -20%, rgba(249, 115, 22, 0.18), transparent 55%);
	opacity: 0.7;
	pointer-events: none;
}
.card > * { position: relative; z-index: 1; }
.card h3 { margin: 0 0 8px 0; font-size: 13px; letter-spacing: 1.5px; color: var(--muted); text-transform: uppercase; font-family: var(--font-mono); }
.card .value { font-size: 32px; font-weight: 700; letter-spacing: 0.6px; background: linear-gradient(90deg, #e2e8f0, #67e8f9); -webkit-background-clip: text; color: transparent; }
.badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; border-radius: 999px; border: 1px solid #24354f; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px; background: rgba(15, 23, 42, 0.7); }
.badge.warn { border-color: rgba(249, 115, 22, 0.6); color: #fdba74; }
.badge.ok { border-color: rgba(52, 211, 153, 0.6); color: #34d399; }
.table-wrap { overflow-x: auto; background: rgba(15, 23, 42, 0.65); border: 1px solid var(--border); border-radius: 14px; padding: 10px; max-height: 70vh; box-shadow: var(--shadow); backdrop-filter: blur(6px); }
.actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.nav { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.nav-link {
	text-decoration: none;
	color: var(--muted);
	padding: 8px 12px;
	border-radius: 10px;
	border: 1px solid var(--border);
	font-weight: 600;
	font-size: 13px;
	background: rgba(15, 23, 42, 0.5);
	transition: all 0.2s ease;
}
.nav-link:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.3), 0 8px 18px rgba(34, 211, 238, 0.15); }
.nav-active { border-color: rgba(34, 211, 238, 0.7); color: var(--accent); background: linear-gradient(120deg, rgba(34, 211, 238, 0.18), rgba(34, 211, 238, 0.04)); }
button {
	background: linear-gradient(120deg, #22d3ee, #38bdf8);
	color: #041318;
	border: none;
	padding: 10px 16px;
	border-radius: 10px;
	cursor: pointer;
	font-weight: 700;
	letter-spacing: 0.4px;
	font-size: 13.5px;
	box-shadow: 0 10px 20px rgba(34, 211, 238, 0.25);
	transition: transform 0.15s ease, box-shadow 0.2s ease;
}
button:hover { transform: translateY(-1px); box-shadow: 0 14px 28px rgba(34, 211, 238, 0.35); }
button.secondary { background: #1f2937; color: var(--text); box-shadow: none; }
.widget-grid { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); margin-top: 14px; align-items: start; }
.widget-card { background: linear-gradient(160deg, var(--card) 0%, var(--card-2) 100%); border: 1px solid var(--border); padding: 16px; border-radius: 14px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
.widget-card::before {
	content: "";
	position: absolute;
	inset: 0;
	background: radial-gradient(320px circle at 20% -10%, rgba(34, 211, 238, 0.12), transparent 60%);
	opacity: 0.7;
	pointer-events: none;
}
.widget-card > * { position: relative; z-index: 1; }
.widget-title { margin: 0 0 8px 0; color: var(--muted); font-size: 12.5px; letter-spacing: 1.2px; text-transform: uppercase; font-family: var(--font-mono); }
.threat-bar { width: 100%; height: 14px; background: #1b2435; border-radius: 999px; overflow: hidden; border: 1px solid #243045; }
.threat-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #22d3ee, #f97316, #f43f5e); transition: width 0.6s ease; }
.threat-card { border-color: rgba(34, 211, 238, 0.25); }
.threat-pips { display: flex; gap: 6px; margin-top: 10px; }
.threat-pips span { flex: 1; height: 6px; border-radius: 999px; background: #1c263a; box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15); }
.threat-pips span.active { background: linear-gradient(90deg, #22d3ee, #38bdf8); }
.threat-pips span.active.warn { background: linear-gradient(90deg, #f97316, #f59e0b); }
.threat-pips span.active.critical { background: linear-gradient(90deg, #f97316, #f43f5e); }
.threat-meta { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; margin-top: 12px; }
.threat-metric { background: rgba(11, 18, 32, 0.65); border: 1px solid #22314a; border-radius: 12px; padding: 10px 12px; }
.threat-metric .metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); font-family: var(--font-mono); }
.threat-metric .metric-value { font-size: 18px; font-weight: 700; margin-top: 4px; }
.threat-status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; border: 1px solid #22314a; background: rgba(15, 23, 42, 0.65); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; font-family: var(--font-mono); }
.threat-status.low { color: #34d399; border-color: rgba(52, 211, 153, 0.55); }
.threat-status.med { color: #f59e0b; border-color: rgba(245, 158, 11, 0.6); }
.threat-status.high { color: #f97316; border-color: rgba(249, 115, 22, 0.6); }
.threat-status.critical { color: #f87171; border-color: rgba(248, 113, 113, 0.6); }
.threat-orbit { position: absolute; right: -48px; bottom: -48px; width: 150px; height: 150px; border-radius: 50%; border: 1px dashed rgba(34, 211, 238, 0.3); opacity: 0.6; pointer-events: none; }
.badge-status { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; border: 1px solid #1f2937; }
.badge-ok { color: #34d399; border-color: #34d39944; }
.badge-warn { color: #f59e0b; border-color: #f59e0b44; }
.badge-crit { color: #f87171; border-color: #f8717144; }
.legend { display: flex; gap: 10px; align-items: center; font-size: 12px; color: var(--muted); flex-wrap: wrap; }
.legend span { display: inline-flex; align-items: center; gap: 6px; }
.dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
.dot-green { background: #34d399; }
.dot-orange { background: #f59e0b; }
.dot-red { background: #f87171; animation: pulse 1.2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.45);} 70% { box-shadow: 0 0 0 10px rgba(248, 113, 113, 0);} 100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0);} }
#map { width: 100%; height: 320px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); box-shadow: inset 0 0 0 1px rgba(34, 211, 238, 0.08); }
.list-compact { list-style: none; padding: 0; margin: 0; font-family: var(--font-mono); }
.list-compact li { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #1f2937; font-size: 12.5px; }
.alert { background: #1b2435; border: 1px solid #243045; border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; }
.alert.high { border-color: #f87171; color: #fca5a5; }
.alert.med { border-color: #f59e0b; color: #fbbf24; }
.alert.low { border-color: #22d3ee; color: #67e8f9; }
.chip { display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 8px; border: 1px solid #1f2937; font-size: 12px; font-weight: 700; }
.chip.http { border-color: rgba(34, 211, 238, 0.7); color: #67e8f9; background: rgba(34, 211, 238, 0.08); }
.chip.ssh { border-color: rgba(249, 115, 22, 0.7); color: #fdba74; background: rgba(249, 115, 22, 0.08); }
.pill { background: rgba(15, 23, 42, 0.7); border-radius: 999px; padding: 6px 12px; font-size: 12px; color: var(--muted); border: 1px solid var(--border); font-family: var(--font-mono); }
.muted { color: var(--muted); }
.footer { margin-top: 18px; color: var(--muted); font-size: 13px; display: flex; gap: 12px; flex-wrap: wrap; font-family: var(--font-mono); }
.log-path { font-family: var(--font-mono); font-size: 12px; color: #d7deea; }
#events-table { width: 100%; border-collapse: collapse; font-size: 13px; font-family: var(--font-mono); }
th, td { padding: 10px 12px; border-bottom: 1px solid #1f2937; text-align: left; }
th { color: var(--muted); letter-spacing: 1px; text-transform: uppercase; font-size: 11.5px; background: #0f172a; position: sticky; top: 0; z-index: 1; }
#events-table tbody tr:nth-child(odd) td { background: rgba(12, 20, 36, 0.6); }
#events-table tbody tr:hover td { background: rgba(34, 211, 238, 0.08); }

.card, .widget-card, .table-wrap { opacity: 0; transform: translateY(12px); animation: rise 0.6s ease forwards; }
.grid .card:nth-child(1) { animation-delay: 0.05s; }
.grid .card:nth-child(2) { animation-delay: 0.12s; }
.grid .card:nth-child(3) { animation-delay: 0.2s; }
.grid .card:nth-child(4) { animation-delay: 0.28s; }
.widget-grid .widget-card:nth-child(1) { animation-delay: 0.1s; }
.widget-grid .widget-card:nth-child(2) { animation-delay: 0.18s; }
.widget-grid .widget-card:nth-child(3) { animation-delay: 0.26s; }
.widget-grid .widget-card:nth-child(4) { animation-delay: 0.34s; }
.table-wrap { animation-delay: 0.4s; }
@keyframes rise { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

@media (max-width: 900px) {
	.app-header { flex-direction: column; align-items: flex-start; }
	.actions { width: 100%; }
}
@media (max-width: 640px) {
	.app-main { padding: 16px; }
	th, td { white-space: nowrap; }
}
@media (prefers-reduced-motion: reduce) {
	.card, .widget-card, .table-wrap { animation: none; opacity: 1; transform: none; }
}
</style>
</head>
<body>
	<header class="app-header">
		<div>
			<div class="brand">Sentinel Hive / Threat Desk</div>
			<div class="sub">Live honeypot telemetry from SSH and HTTP traps</div>
		</div>
		<div class="actions">
			<nav class="nav">
				<a class="nav-link nav-active" href="/">Dashboard</a>
				<a class="nav-link" href="/live-http">Live HTTP</a>
				<a class="nav-link" href="/live-ssh">Live SSH</a>
				<a class="nav-link" href="/replay-ssh">Replay</a>
				<a class="nav-link" href="/ssh-session-replay">Sessions</a>
			</nav>
			<button id="refresh">Refresh now</button>
			<span class="pill" id="last-update">Last update: --</span>
		</div>
	</header>

	<main class="app-main">
		<div class="grid">
			<div class="card">
				<h3>Total Events</h3>
				<div class="value" id="stat-total">{{ stats.total_events }}</div>
				<div class="muted">Max returned: {{ max_events }}</div>
			</div>
			<div class="card">
				<h3>HTTP Attempts</h3>
				<div class="value" id="stat-http">{{ stats.http_attempts }}</div>
				<span class="badge warn">Edge honeypot</span>
			</div>
			<div class="card">
				<h3>SSH Attempts</h3>
				<div class="value" id="stat-ssh">{{ stats.ssh_attempts }}</div>
				<span class="badge warn">Cowrie</span>
			</div>
			<div class="card">
				<h3>Unique IPs</h3>
				<div class="value" id="stat-ips">{{ stats.unique_ips }}</div>
				<span class="badge ok">Deduplicated</span>
			</div>
		</div>

		<div style="margin: 18px 0 10px 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
			<div class="muted">Live feed of SSH and HTTP attack attempts</div>
			<div class="actions">
				<span class="pill">HTTP log: <span class="log-path">Pot ID 1, located somewere</span></span>
				<span class="pill">SSH source: <span class="log-path">{{ ssh_source }}</span></span>
			</div>
		</div>

		<div class="widget-grid">
			<div class="widget-card threat-card">
				<h4 class="widget-title">Threat Level</h4>
				<div class="threat-bar"><div id="threat-fill" class="threat-fill"></div></div>
				<div class="threat-pips" id="threat-pips">
					<span></span>
					<span></span>
					<span></span>
					<span></span>
				</div>
				<div class="threat-meta">
					<div class="threat-metric">
						<div class="metric-label">Score</div>
						<div id="threat-score" class="metric-value">--</div>
					</div>
					<div class="threat-metric">
						<div class="metric-label">Status</div>
						<div id="threat-status" class="threat-status">--</div>
					</div>
				</div>
				<div id="threat-label" class="muted" style="margin-top:8px; font-weight:700;">Calculating.</div>
				<div class="threat-orbit"></div>
			</div>
			<div class="widget-card">
				<h4 class="widget-title">Protocol Split</h4>
				<canvas id="protocol-chart" height="140"></canvas>
			</div>
			<div class="widget-card">
				<h4 class="widget-title">Top Attacker IPs</h4>
				<ul id="top-ips" class="list-compact"></ul>
			</div>
			<div class="widget-card">
				<h4 class="widget-title">Node Health (simulated)</h4>
				<div class="legend" style="margin-bottom:8px;">
					<span><span class="dot dot-green"></span> Healthy</span>
					<span><span class="dot dot-orange"></span> Degraded</span>
					<span><span class="dot dot-red"></span> Under Attack</span>
				</div>
				<div id="node-health" class="muted">Loading…</div>
			</div>
		</div>

		<div class="widget-grid" style="grid-template-columns: 2fr 1fr;">
			<div class="widget-card" style="grid-column: span 2;">
				<div style="display:flex; justify-content: space-between; align-items:center; gap:10px;">
					<h4 class="widget-title" style="margin:0;">Global Sensor Grid <span class="pill" id="sim-status">SIMULATED</span></h4>
					<div class="legend">
						<span><span class="dot dot-green"></span> Normal</span>
						<span><span class="dot dot-orange"></span> Degraded</span>
						<span><span class="dot dot-red"></span> Under Attack</span>
					</div>
				</div>
				<div id="map"></div>
				<div id="node-counter" class="muted" style="margin-top:8px;">Active Nodes: —</div>
			</div>
			<div class="widget-card">
				<h4 class="widget-title">Attack Timeline (60m)</h4>
				<canvas id="timeline-chart" height="180"></canvas>
			</div>
			<div class="widget-card">
				<h4 class="widget-title">Recent Alerts (Simulated)</h4>
				<div id="alerts"></div>
			</div>
		</div>

		<div class="table-wrap">
			<table id="events-table">
				<thead>
					<tr>
						<th>Time (UTC)</th>
						<th>Source</th>
						<th>Event</th>
						<th>IP</th>
						<th>Username</th>
						<th>Password</th>
						<th>Path / Message</th>
					</tr>
				</thead>
				<tbody id="events-body"></tbody>
			</table>
		</div>

		<div class="footer">
			<span>Data auto-refreshes every 10s.</span>
			<span>Configure paths with HTTP_LOG_PATH and SSH_LOG_PATH environment variables.</span>
			<span>Current cap: {{ max_events }} events.</span>
		</div>
	</main>

	<script>
		// External libs
	</script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

	<script>
		const tbody = document.getElementById('events-body');
		const lastUpdate = document.getElementById('last-update');
		const statTotal = document.getElementById('stat-total');
		const statHttp = document.getElementById('stat-http');
		const statSsh = document.getElementById('stat-ssh');
		const statIps = document.getElementById('stat-ips');
		const threatFill = document.getElementById('threat-fill');
		const threatLabel = document.getElementById('threat-label');
		const threatScoreEl = document.getElementById('threat-score');
		const threatStatusEl = document.getElementById('threat-status');
		const threatPips = document.querySelectorAll('#threat-pips span');
		const topIpsEl = document.getElementById('top-ips');
		const alertsEl = document.getElementById('alerts');
		const nodeHealthEl = document.getElementById('node-health');
		const nodeCounterEl = document.getElementById('node-counter');
		const simStatus = document.getElementById('sim-status');

		let protocolChart;
		let timelineChart;
		let map;
		let markers = L.layerGroup();

		function threatLevelFromLabel(label) {
			const value = (label || '').toLowerCase();
			if (value === 'critical') return 4;
			if (value === 'high') return 3;
			if (value === 'medium' || value === 'med') return 2;
			if (value === 'low') return 1;
			return 0;
		}

		function updateThreat(threat) {
			const score = threat && typeof threat.score === 'number' ? Math.round(threat.score) : 0;
			const label = threat && threat.label ? String(threat.label).toUpperCase() : 'N/A';
			const labelKey = label.toLowerCase();
			threatFill.style.width = Math.min(100, score) + '%';
			threatLabel.textContent = `Threat Level: ${label} (${score})`;
			if (threatScoreEl) {
				threatScoreEl.textContent = String(score);
			}
			if (threatStatusEl) {
				const statusClass = labelKey === 'medium' ? 'med' : labelKey;
				threatStatusEl.textContent = label;
				threatStatusEl.classList.remove('low', 'med', 'high', 'critical');
				if (['low', 'med', 'high', 'critical'].includes(statusClass)) {
					threatStatusEl.classList.add(statusClass);
				}
			}
			const levelFromLabel = threatLevelFromLabel(labelKey);
			const levelFromScore = score >= 75 ? 4 : score >= 50 ? 3 : score >= 25 ? 2 : score > 0 ? 1 : 0;
			const level = levelFromLabel || levelFromScore;
			const variant = level >= 4 ? 'critical' : level >= 3 ? 'warn' : '';
			if (threatPips.length) {
				threatPips.forEach((pip, index) => {
					pip.classList.remove('active', 'warn', 'critical');
					if (index < level) {
						pip.classList.add('active');
						if (variant) pip.classList.add(variant);
					}
				});
			}
		}


		function updateProtocol(split) {
			if (!protocolChart) return;
			protocolChart.data.datasets[0].data = [split.ssh || 0, split.http || 0];
			protocolChart.update();
		}

		function updateTimeline(timeline) {
			if (!timelineChart || !timeline) return;
			const labels = (timeline.labels || []).map(t => new Date(t).toISOString().slice(11,16));
			timelineChart.data.labels = labels;
			timelineChart.data.datasets[0].data = timeline.ssh || [];
			timelineChart.data.datasets[1].data = timeline.http || [];
			timelineChart.update();
		}

		function updateTopIps(list) {
			topIpsEl.innerHTML = '';
			(list || []).sort((a,b)=> (b.count||0)-(a.count||0)).slice(0,10).forEach(item => {
				const li = document.createElement('li');
				li.innerHTML = `<span>${item.ip} (${item.country || ''})</span><span>${item.count} | ${item.asn || ''}</span>`;
				topIpsEl.appendChild(li);
			});
		}

		function updateAlerts(alerts) {
			alertsEl.innerHTML = '';
			(alerts || []).slice().reverse().forEach(a => {
				const div = document.createElement('div');
				div.className = `alert ${a.severity || 'low'}`;
				div.innerHTML = `<strong>${a.title}</strong><div class="muted" style="margin-top:4px;">${a.detail}</div>`;
				alertsEl.appendChild(div);
			});
		}

		function updateNodeHealth(h) {
			if (!h) { nodeHealthEl.textContent = 'n/a'; return; }
			nodeHealthEl.textContent = `Healthy: ${h.healthy || 0} | Degraded: ${h.degraded || 0} | Under Attack: ${h.under_attack || 0}`;
			nodeCounterEl.textContent = `Active Nodes: ${h.total || (h.healthy||0)+(h.degraded||0)+(h.under_attack||0)}`;
		}

		function updateNodes(nodes) {
			markers.clearLayers();
			(nodes || []).forEach(node => {
				const color = node.status === 'under_attack' ? '#f87171' : node.status === 'degraded' ? '#f59e0b' : '#34d399';
				const icon = L.divIcon({ className: 'node-icon', html: `<div style="width:12px;height:12px;border-radius:50%;background:${color};box-shadow:0 0 10px ${color};"></div>` });
				L.marker([node.lat, node.lon], { icon }).bindPopup(`${node.name}<br>Status: ${node.status}`).addTo(markers);
			});
		}

		function setSimStatus(ok) {
			if (!simStatus) return;
			simStatus.textContent = ok ? 'SIMULATED' : 'SIM DATA STALE';
			simStatus.classList.toggle('badge-warn', !ok);
		}

		async function loadWidgets() {
			try {
				const res = await fetch('/api/sim/telemetry');
				const data = await res.json();
				setSimStatus(true);
				updateThreat(data.threat_level || {});
				updateProtocol(data.protocol_split || {});
				updateTimeline(data.timeline_60m || {});
				updateTopIps(data.top_attackers || []);
				updateAlerts(data.alerts || []);
				updateNodeHealth(data.node_health || {});
				updateNodes(data.global_nodes || []);
				if (data.stats) {
					console.log('Received stats:', data.stats);
					if (data.stats.total_events !== undefined) statTotal.textContent = data.stats.total_events;
					if (data.stats.http_attempts !== undefined) statHttp.textContent = data.stats.http_attempts;
					if (data.stats.ssh_attempts !== undefined) statSsh.textContent = data.stats.ssh_attempts;
					if (data.stats.unique_ips !== undefined) statIps.textContent = data.stats.unique_ips;
				}
			} catch (err) {
				setSimStatus(false);
			}
		}

		function renderRow(evt) {
			const tr = document.createElement('tr');
			const cells = [
				evt.timestamp ? new Date(evt.timestamp).toISOString().replace('T', ' ').replace('Z', '') : '—',
				`<span class="chip ${evt.source === 'HTTP' ? 'http' : 'ssh'}">${evt.source}</span>`,
				evt.event || 'n/a',
				evt.ip || 'n/a',
				evt.username || '—',
				evt.password || '—',
				evt.path || evt.message || evt.query || '—',
			];
			cells.forEach(c => {
				const td = document.createElement('td');
				td.innerHTML = c;
				tr.appendChild(td);
			});
			return tr;
		}

		function initCharts() {
			const protocolCtx = document.getElementById('protocol-chart');
			protocolChart = new Chart(protocolCtx, {
				type: 'doughnut',
				data: { labels: ['SSH', 'HTTP'], datasets: [{ data: [1, 1], backgroundColor: ['#f97316', '#22d3ee'] }] },
				options: { plugins: { legend: { labels: { color: '#e8ecf3' } } } }
			});
			const timelineCtx = document.getElementById('timeline-chart');
			timelineChart = new Chart(timelineCtx, {
				type: 'line',
				data: { labels: [], datasets: [
					{ label: 'SSH', data: [], borderColor: '#f97316', backgroundColor: '#f9731615', tension: 0.3, fill: true },
					{ label: 'HTTP', data: [], borderColor: '#22d3ee', backgroundColor: '#22d3ee15', tension: 0.3, fill: true },
				] },
				options: { plugins: { legend: { labels: { color: '#e8ecf3' } } }, scales: { x: { ticks: { color: '#a5b4c6' } }, y: { ticks: { color: '#a5b4c6' } } } }
			});
		}

		function initMap() {
			map = L.map('map', { worldCopyJump: true, zoomControl: false }).setView([20, 0], 2);
			L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
				attribution: '&copy; OpenStreetMap & Carto',
				maxZoom: 6,
			}).addTo(map);
			markers.addTo(map);
		}

		async function loadEvents() {
			try {
				const res = await fetch('/api/events');
				const data = await res.json();
				tbody.innerHTML = '';
				data.events.forEach(evt => tbody.appendChild(renderRow(evt)));
				statTotal.textContent = data.stats.total_events;
				statHttp.textContent = data.stats.http_attempts;
				statSsh.textContent = data.stats.ssh_attempts;
				statIps.textContent = data.stats.unique_ips;
				lastUpdate.textContent = 'Last update: ' + data.stats.last_update;
			} catch (err) {
				lastUpdate.textContent = 'Failed to refresh: ' + err;
			}
		}

		document.getElementById('refresh').addEventListener('click', loadEvents);
		initCharts();
		initMap();
		loadEvents();
		loadWidgets();
		setInterval(loadEvents, 10000);
		setInterval(loadWidgets, 8000);
	</script>
</body>
</html>
