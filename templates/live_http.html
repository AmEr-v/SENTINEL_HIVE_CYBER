<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sentinel Hive - Live HTTP</title>
	<style>
		:root {
			--bg: #0b1220; --panel: #0f172a; --card: #111827; --accent: #22d3ee; --accent-2: #f97316;
			--text: #e8ecf3; --muted: #a5b4c6; --font: 'JetBrains Mono', 'IBM Plex Mono', 'SFMono-Regular', Menlo, Consolas, monospace;
		}
		* { box-sizing: border-box; }
		body { margin: 0; background: radial-gradient(circle at 20% 20%, #132644, var(--bg)); color: var(--text); font-family: var(--font); font-size: 14px; line-height: 1.55; min-height: 100vh; }
		header { padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1f2937; background: linear-gradient(90deg, #0f172a, #0b1220); position: sticky; top: 0; z-index: 10; }
		.brand { letter-spacing: 3px; text-transform: uppercase; color: var(--accent); font-weight: 800; font-size: 18px; }
		.sub { color: var(--muted); font-size: 13px; margin-top: 6px; }
		main { padding: 22px 24px 54px 24px; max-width: 1280px; margin: auto; }
		.actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
		.badge { display: inline-block; padding: 6px 10px; border-radius: 999px; border: 1px solid #1f2937; font-size: 12px; color: var(--muted); }
		.badge.ok { border-color: #34d39966; color: #34d399; }
		.badge.warn { border-color: #f59e0b66; color: #f59e0b; }
		.nav { display: flex; gap: 10px; align-items: center; }
		.nav-link { text-decoration: none; color: var(--muted); padding: 8px 12px; border-radius: 8px; border: 1px solid #1f2937; font-weight: 700; font-size: 13px; }
		.nav-link:hover { border-color: var(--accent); color: var(--accent); }
		.nav-active { border-color: var(--accent); color: var(--accent); }
		.table-wrap { overflow-x: auto; background: var(--panel); border: 1px solid #1f2937; border-radius: 12px; padding: 8px; max-height: 75vh; }
		table { width: 100%; border-collapse: collapse; font-size: 13.5px; }
		th, td { padding: 10px 12px; border-bottom: 1px solid #1f2937; text-align: left; }
		th { color: var(--muted); letter-spacing: 1px; text-transform: uppercase; font-size: 12.5px; background: #0f172a; position: sticky; top: 0; z-index: 1; }
		tr:hover td { background: #0f1c33; }
		.pill { background: #1b2435; border-radius: 22px; padding: 6px 12px; font-size: 12px; color: var(--muted); }
		button { background: var(--accent); color: #0b1220; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 800; letter-spacing: 0.5px; font-size: 13.5px; box-shadow: 0 4px 12px #22d3ee44; }
		.muted { color: var(--muted); }
	</style>
</head>
<body>
	<header>
		<div>
			<div class="brand">Sentinel Hive / Live HTTP</div>
			<div class="sub">Edge honeypot request + credential attempts</div>
		</div>
		<div class="actions">
			<nav class="nav">
				<a class="nav-link" href="/">Dashboard</a>
				<a class="nav-link nav-active" href="/live-http">Live HTTP</a>
				<a class="nav-link" href="/live-ssh">Live SSH</a>
				<a class="nav-link" href="/replay-ssh">Replay</a>
				<a class="nav-link" href="/ssh-session-replay">Sessions</a>
			</nav>
			<button id="refresh">Refresh now</button>
			<span class="pill" id="last-update">Last update: --</span>
			<span class="badge" id="data-source">Data source: --</span>
			<span class="badge" id="last-seen">Last event: --</span>
		</div>
	</header>

	<main>
		<div class="muted" style="margin-bottom:12px;">Log file: <span style="color:#d7deea;">{{ http_log }}</span> &nbsp;|&nbsp; Showing up to {{ max_events }} entries</div>
		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Time (UTC)</th>
						<th>IP</th>
						<th>Method</th>
						<th>Path</th>
						<th>Query</th>
						<th>User</th>
						<th>Password</th>
						<th>User-Agent</th>
					</tr>
				</thead>
				<tbody id="events-body"></tbody>
			</table>
		</div>
	</main>

	<script>
		const tbody = document.getElementById('events-body');
		const lastUpdate = document.getElementById('last-update');
		const dataSourceEl = document.getElementById('data-source');
		const lastSeenEl = document.getElementById('last-seen');
		let lastEventTs = null;
		let lastSeenTimer = null;

		function renderRow(evt) {
			const tr = document.createElement('tr');
			const cells = [
				evt.timestamp ? new Date(evt.timestamp).toISOString().replace('T',' ').replace('Z','') : '—',
				evt.ip || 'n/a',
				evt.method || '—',
				evt.path || '—',
				evt.query || '—',
				evt.username || '—',
				evt.password || '—',
				evt.user_agent || '—',
			];
			cells.forEach(c => { const td = document.createElement('td'); td.textContent = c; tr.appendChild(td); });
			return tr;
		}

		function setSourceLabel(source) {
			if (!dataSourceEl) return;
			dataSourceEl.textContent = 'Data source: ' + (source || 'n/a');
			dataSourceEl.classList.toggle('ok', source === 'VM ingest');
			dataSourceEl.classList.toggle('warn', source && source !== 'VM ingest');
		}

		function startLastSeenTimer() {
			if (lastSeenTimer) return;
			lastSeenTimer = setInterval(() => {
				if (!lastSeenEl) return;
				if (!lastEventTs) {
					lastSeenEl.textContent = 'Last event: n/a';
					return;
				}
				const now = Date.now();
				const diffSec = Math.max(0, Math.floor((now - lastEventTs) / 1000));
				lastSeenEl.textContent = 'Last event: ' + diffSec + 's ago';
			}, 1000);
		}

		async function loadEvents() {
			try {
				const res = await fetch('/api/http-events');
				const data = await res.json();
				tbody.innerHTML = '';
				data.events.forEach(evt => tbody.appendChild(renderRow(evt)));
				lastUpdate.textContent = 'Last update: ' + data.stats.last_update;
				setSourceLabel(data.source);
				if (data.events && data.events.length) {
					const latest = data.events[0];
					const ts = latest.timestamp ? Date.parse(latest.timestamp) : NaN;
					if (!isNaN(ts)) lastEventTs = ts;
				}
				startLastSeenTimer();
			} catch (err) {
				lastUpdate.textContent = 'Failed to refresh: ' + err;
			}
		}

		document.getElementById('refresh').addEventListener('click', loadEvents);
		loadEvents();
		setInterval(loadEvents, 8000);
	</script>
</body>
</html>
