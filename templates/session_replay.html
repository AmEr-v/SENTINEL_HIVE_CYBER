<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sentinel Hive - SSH Session Replay</title>
	<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');

:root {
	--bg: #0b1220;
	--panel: #0f172a;
	--card: #0f1b2e;
	--card-2: #0c1526;
	--accent: #22d3ee;
	--accent-2: #f97316;
	--text: #e2e8f0;
	--muted: #94a3b8;
	--border: #1f2a44;
	--shadow: 0 20px 50px rgba(2, 6, 23, 0.55);
	--font-body: 'Space Grotesk', sans-serif;
	--font-mono: 'IBM Plex Mono', 'JetBrains Mono', monospace;
}
* { box-sizing: border-box; }
body {
	margin: 0;
	min-height: 100vh;
	color: var(--text);
	font-family: var(--font-body);
	font-size: 15px;
	line-height: 1.6;
	background:
		radial-gradient(1200px circle at 15% -10%, #1b2a49 0%, rgba(27, 42, 73, 0) 60%),
		radial-gradient(900px circle at 90% 0%, #12374d 0%, rgba(18, 55, 77, 0) 65%),
		linear-gradient(180deg, #0b1220 0%, #0b1324 100%);
}
body::before {
	content: "";
	position: fixed;
	inset: 0;
	background:
		repeating-linear-gradient(90deg, rgba(148, 163, 184, 0.04) 0 1px, transparent 1px 140px),
		repeating-linear-gradient(0deg, rgba(148, 163, 184, 0.035) 0 1px, transparent 1px 90px);
	pointer-events: none;
	z-index: 0;
}
body::after {
	content: "";
	position: fixed;
	inset: -10% auto auto -10%;
	width: 420px;
	height: 420px;
	background: radial-gradient(circle, rgba(34, 211, 238, 0.18), transparent 70%);
	pointer-events: none;
	z-index: 0;
}
.app-header {
	padding: 20px 28px;
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 16px;
	border-bottom: 1px solid var(--border);
	background: linear-gradient(110deg, rgba(15, 23, 42, 0.94), rgba(11, 18, 32, 0.92));
	position: sticky;
	top: 0;
	z-index: 20;
	backdrop-filter: blur(14px);
	box-shadow: 0 12px 30px rgba(2, 6, 23, 0.45);
}
.brand { letter-spacing: 4px; text-transform: uppercase; color: var(--accent); font-weight: 700; font-size: 19px; }
.sub { color: var(--muted); font-size: 13px; margin-top: 6px; font-family: var(--font-mono); }
.actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.nav { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.nav-link {
	text-decoration: none;
	color: var(--muted);
	padding: 8px 12px;
	border-radius: 10px;
	border: 1px solid var(--border);
	font-weight: 600;
	font-size: 13px;
	background: rgba(15, 23, 42, 0.5);
	transition: all 0.2s ease;
}
.nav-link:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.3), 0 8px 18px rgba(34, 211, 238, 0.15); }
.nav-active { border-color: rgba(34, 211, 238, 0.7); color: var(--accent); background: linear-gradient(120deg, rgba(34, 211, 238, 0.18), rgba(34, 211, 238, 0.04)); }
button {
	background: linear-gradient(120deg, #22d3ee, #38bdf8);
	color: #041318;
	border: none;
	padding: 8px 12px;
	border-radius: 10px;
	cursor: pointer;
	font-weight: 700;
	letter-spacing: 0.4px;
	font-size: 13px;
	box-shadow: 0 10px 20px rgba(34, 211, 238, 0.25);
	transition: transform 0.15s ease, box-shadow 0.2s ease;
}
button:hover { transform: translateY(-1px); box-shadow: 0 14px 28px rgba(34, 211, 238, 0.35); }
.app-main { padding: 24px 28px 60px; max-width: 1280px; margin: auto; position: relative; z-index: 1; }
.status-grid { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin: 18px 0 16px; }
.status-card {
	background: linear-gradient(160deg, var(--card) 0%, var(--card-2) 100%);
	border: 1px solid var(--border);
	padding: 14px 16px;
	border-radius: 14px;
	box-shadow: var(--shadow);
	position: relative;
	overflow: hidden;
}
.status-card::before {
	content: "";
	position: absolute;
	inset: 0;
	background: radial-gradient(320px circle at 15% -10%, rgba(34, 211, 238, 0.12), transparent 60%);
	opacity: 0.7;
	pointer-events: none;
}
.status-card > * { position: relative; z-index: 1; }
.status-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); font-family: var(--font-mono); }
.status-value { font-size: 15px; font-weight: 600; margin-top: 6px; color: var(--text); word-break: break-all; }
.status-hint { font-size: 11px; margin-top: 6px; font-family: var(--font-mono); }
.status-pill { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px; border: 1px solid #22314a; background: rgba(15, 23, 42, 0.6); font-size: 11px; letter-spacing: 0.6px; text-transform: uppercase; font-family: var(--font-mono); }
.section-title { font-size: 16px; font-weight: 700; letter-spacing: 0.4px; }
.section-sub { color: var(--muted); font-size: 13px; margin-top: 4px; font-family: var(--font-mono); }
.table-head { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 12px; }
.table-wrap { overflow-x: auto; background: rgba(15, 23, 42, 0.65); border: 1px solid var(--border); border-radius: 14px; padding: 10px; max-height: 70vh; box-shadow: var(--shadow); backdrop-filter: blur(6px); }
table { width: 100%; border-collapse: collapse; font-size: 13px; font-family: var(--font-mono); }
th, td { padding: 10px 12px; border-bottom: 1px solid #1f2937; text-align: left; }
th { color: var(--muted); letter-spacing: 1px; text-transform: uppercase; font-size: 11.5px; background: #0f172a; position: sticky; top: 0; z-index: 1; }
tbody tr:nth-child(odd) td { background: rgba(12, 20, 36, 0.6); }
tbody tr:hover td { background: rgba(34, 211, 238, 0.08); }
.log-wrap { background: rgba(15, 23, 42, 0.65); border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); overflow: hidden; }
.log-view { margin: 0; padding: 14px; background: rgba(7, 12, 22, 0.9); color: #e2e8f0; font-size: 12.5px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; font-family: var(--font-mono); max-height: 65vh; overflow-y: auto; }
.muted { color: var(--muted); }

@media (max-width: 900px) {
	.app-header { flex-direction: column; align-items: flex-start; }
	.actions { width: 100%; }
}
@media (max-width: 640px) {
	.app-main { padding: 16px; }
	th, td { white-space: nowrap; }
}
	</style>
</head>
<body>
	<header class="app-header">
		<div>
			<div class="brand">SSH Session Replay</div>
			<div class="sub">Select a recorded attacker session to replay keystrokes</div>
		</div>
		<div class="actions">
			<nav class="nav">
				<a class="nav-link" href="/">Dashboard</a>
				<a class="nav-link" href="/live-http">Live HTTP</a>
				<a class="nav-link" href="/live-ssh">Live SSH</a>
				<a class="nav-link" href="/replay-ssh">Replay</a>
				<a class="nav-link nav-active" href="/ssh-session-replay">Sessions</a>
			</nav>
		</div>
	</header>

	<main class="app-main">
		<div class="status-grid">
			<div class="status-card">
				<div class="status-label">Sessions</div>
				<div class="status-value" id="session-meta">Loading sessions.</div>
			</div>
			<div class="status-card">
				<div class="status-label">Selected session</div>
				<div class="status-value" id="session-current">None</div>
				<div class="status-hint muted">Click a session to replay</div>
			</div>
			<div class="status-card">
				<div class="status-label">Replay status</div>
				<div class="status-value"><span class="status-pill" id="replay-status">Idle</span></div>
				<div class="status-hint muted">Streamed line-by-line</div>
			</div>
			<div class="status-card">
				<div class="status-label">Source</div>
				<div class="status-value">Cowrie session logs</div>
			</div>
		</div>

		<div class="table-head">
			<div>
				<div class="section-title">Session list</div>
				<div class="section-sub">Newest sessions first. Click replay to stream keystrokes.</div>
			</div>
		</div>
		<div class="table-wrap">
			<table>
				<thead>
					<tr>
						<th>Time (UTC)</th>
						<th>Attacker IP</th>
						<th>Session ID</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody id="sessions-body"></tbody>
			</table>
		</div>

		<div class="table-head">
			<div>
				<div class="section-title">Replay output</div>
				<div class="section-sub">Live output from the selected session.</div>
			</div>
		</div>
		<div class="log-wrap">
			<pre class="log-view" id="session-output"></pre>
		</div>
	</main>

	<script>
		const tbody = document.getElementById('sessions-body');
		const meta = document.getElementById('session-meta');
		const output = document.getElementById('session-output');
		const statusEl = document.getElementById('replay-status');
		const sessionCurrent = document.getElementById('session-current');
		let sessions = [];
		let currentController = null;
		let selectedSessionId = '';

		function shorten(id) {
			return id.length > 12 ? id.slice(0, 12) + '.' : id;
		}

		function stopReplay() {
			if (currentController) {
				currentController.abort();
				currentController = null;
			}
		}

		function setCurrentSession(sessionId) {
			selectedSessionId = sessionId || '';
			if (sessionCurrent) {
				sessionCurrent.textContent = selectedSessionId || 'None';
			}
		}

		async function startReplay(sessionId) {
			stopReplay();
			output.textContent = '';
			setCurrentSession(sessionId);
			statusEl.textContent = 'Replaying ' + sessionId + '.';
			const ctrl = new AbortController();
			currentController = ctrl;
			try {
				const res = await fetch('/api/ssh-session-replay/' + encodeURIComponent(sessionId), { signal: ctrl.signal });
				if (!res.ok || !res.body) {
					statusEl.textContent = 'Replay failed (HTTP ' + res.status + ')';
					return;
				}
				const reader = res.body.getReader();
				const decoder = new TextDecoder();
				while (true) {
					const { value, done } = await reader.read();
					if (done) break;
					output.textContent += decoder.decode(value, { stream: true });
					output.scrollTop = output.scrollHeight;
				}
				statusEl.textContent = 'Replay finished';
			} catch (err) {
				if (err.name === 'AbortError') {
					statusEl.textContent = 'Replay stopped';
				} else {
					statusEl.textContent = 'Replay error: ' + err;
				}
			}
		}

		function renderSessions() {
			tbody.innerHTML = '';
			if (!sessions.length) {
				meta.textContent = 'No sessions available';
				setCurrentSession('');
				return;
			}
			meta.textContent = 'Sessions: ' + sessions.length + ' (newest first)';
			sessions.forEach(sess => {
				const tr = document.createElement('tr');
				const cells = [
					sess.timestamp ? new Date(sess.timestamp).toISOString().replace('T', ' ').replace('Z', '') : '-',
					sess.ip || 'n/a',
					shorten(sess.session),
				];
				cells.forEach(c => { const td = document.createElement('td'); td.textContent = c; tr.appendChild(td); });
				const action = document.createElement('td');
				const btn = document.createElement('button');
				btn.textContent = 'Replay';
				btn.addEventListener('click', () => startReplay(sess.session));
				action.appendChild(btn);
				tr.appendChild(action);
				tbody.appendChild(tr);
			});
			const sessionIds = new Set(sessions.map(sess => sess.session));
			if (!selectedSessionId || !sessionIds.has(selectedSessionId)) {
				setCurrentSession('');
			}
		}

		async function loadSessions() {
			try {
				const res = await fetch('/api/ssh-sessions');
				const data = await res.json();
				sessions = data.sessions || [];
				renderSessions();
			} catch (err) {
				meta.textContent = 'Failed to load sessions: ' + err;
			}
		}

		loadSessions();
	</script>
</body>
</html>
